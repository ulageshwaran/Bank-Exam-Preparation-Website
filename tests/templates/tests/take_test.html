{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/test_interface.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid test-container">
    <!-- Test Header -->
    <div class="test-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <h4 class="mb-0">{{ test.title }}</h4>
                </div>
                <div class="col-md-4 text-center">
                    <div class="section-indicator">
                        <i class="bi bi-folder"></i>
                        <span id="current-section-name">{{ sections.0.section_name }}</span>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="timer-display" id="timer-display">
                        <i class="bi bi-stopwatch"></i>
                        <span>{{ sections.0.section_duration|stringformat:"02d" }}:00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <div class="row">
            <!-- Question Area -->
            <div class="col-lg-8">
                <div class="question-container" id="question-container">
                    <!-- Question will be rendered here by JavaScript -->
                </div>

                <!-- Navigation Controls -->
                <div class="navigation-controls">
                    <button type="button" class="btn btn-outline-secondary" id="prev-btn">
                        <i class="bi bi-arrow-left"></i> Previous
                    </button>
                    <button type="button" class="btn btn-outline-warning" id="mark-review-btn">
                        <i class="bi bi-bookmark"></i> Mark for Review
                    </button>
                    <button type="button" class="btn btn-outline-danger" id="clear-response-btn">
                        <i class="bi bi-x-circle"></i> Clear Response
                    </button>
                    <button type="button" class="btn btn-primary ms-auto" id="next-btn">
                        Next <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Question Palette -->
            <div class="col-lg-4">
                <div class="question-palette">
                    <h5 class="mb-3">Question Palette</h5>

                    <!-- Test Stats -->
                    <div class="test-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Questions:</span>
                            <span class="stat-value">{{ test_questions.count }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Answered:</span>
                            <span class="stat-value" id="answered-count">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Not Answered:</span>
                            <span class="stat-value" id="not-answered-count">{{ test_questions.count }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Marked:</span>
                            <span class="stat-value" id="marked-count">0</span>
                        </div>
                    </div>

                    <!-- Palette Grid -->
                    <div id="question-palette" class="mt-3">
                        <!-- Palette will be rendered here by JavaScript -->
                    </div>

                    <!-- Legend -->
                    <div class="palette-legend">
                        <div class="legend-item">
                            <div class="legend-box answered"></div>
                            <span>Answered</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box not-visited"></div>
                            <span>Not Answered</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box marked"></div>
                            <span>Marked for Review</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box current"></div>
                            <span>Current Question</span>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="button" class="btn btn-success w-100 mt-3" id="submit-test-btn">
                        <i class="bi bi-check-circle"></i> Submit Test
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Form for Submission -->
    <form method="POST" id="test-form" style="display: none;">
        {% csrf_token %}
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Safely output test data as JSON -->
{{ test_data|json_script:"test-data-json" }}

<script>
    console.log('Initializing test data...');

    try {
        // Parse the JSON data from the script tag
        const rawData = JSON.parse(document.getElementById('test-data-json').textContent);
        window.testData = rawData;
        console.log('Test data loaded:', window.testData);

        // Render markdown in question text
        if (typeof marked !== 'undefined') {
            window.testData.questions.forEach(q => {
                if (q.text) q.text = marked.parse(q.text);
                if (q.group_context_text) {
                    // Check if it's NOT JSON before parsing as markdown
                    if (!q.group_context_text.trim().startsWith('{')) {
                        q.group_context_text = marked.parse(q.group_context_text);
                    }
                }
            });
            console.log('Markdown parsing complete');
        } else {
            console.warn('Marked library not loaded, skipping markdown parsing');
        }
    } catch (e) {
        console.error('Error initializing test data:', e);
    }
</script>
<script src="{% static 'js/test_navigation.js' %}"></script>
{% endblock %}